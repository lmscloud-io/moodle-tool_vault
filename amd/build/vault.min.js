define(["core/modal_factory","core/modal_events","core/templates","core/notification","core/str","core/pending","core/fragment"],function(a,b,c,d,e,f,g){var h={START_BACKUP:'form[data-action="startbackup"]',START_DRYRUN:'form[data-action="startdryrun"]',START_RESTORE:'form[data-action="startrestore"]'},i=function(b){return a.create(b).then(function(a){return b.buttons&&Object.keys(b.buttons).forEach(function(c){var d=b.buttons[c],e=a.getFooter().find("[data-action='"+c+"']");a.asyncSet(d,e.text.bind(e))}),a})},j=function(a,b){var c=b.getBody()[0],d=["passphrase","description","bucket","expiredays","backupplugincode"];for(var e in d){var f=d[e],g=c.querySelector('[name="'+f+'"]'),h=a.querySelector('input[name="'+f+'"]');g&&h&&(h.value=g.value)}a.setAttribute("action",a.getAttribute("data-url")),a.submit()},k=function(b,c,e,f,h){var j=null;return i({type:a.types.CANCEL,title:b,body:c}).then(function(a){return j=a,j.show(),g.loadFragment("tool_vault",e,f,h)}).then(function(a){return j.destroy(),a})["catch"](function(a){j?j.setBody(a.message):d.exception(a)})},l=function(b){var c,d,f;return e.get_strings([{key:"startbackup",component:"tool_vault"},{key:"pleasewait",component:"tool_vault"},{key:"startbackup",component:"tool_vault"}]).then(function(a){return c=a[0],d=a[1],f=a[2],k(c,d,"start_backup",b)}).then(function(b){return b?i({type:a.types.SAVE_CANCEL,title:c,body:b,buttons:{save:f},removeOnClose:!0}):null})},m=function(){var a=document.querySelector(h.START_BACKUP);if(a){var c=a.getAttribute("data-contextid");a.addEventListener("submit",function(e){e.preventDefault();var g=new f("tool/vault:startBackupPopup");l(c).then(function(c){return c&&(c.show(),c.getRoot().on(b.save,function(){j(a,c)}),c.getRoot().on(b.cancel,function(){c.hide()})),g.resolve(),null})["catch"](function(a){d.exception(a),g.resolve()})})}},n=function(f){var g=document.querySelector(h.START_DRYRUN+'[data-backupkey="'+f+'"]');g&&g.addEventListener("submit",function(f){f.preventDefault(),i({type:a.types.SAVE_CANCEL,title:e.get_string("startdryrun","tool_vault"),body:c.render("tool_vault/start_restore_popup",{dryrun:1,encrypted:parseInt(g.getAttribute("data-encrypted"))}),buttons:{save:e.get_string("startdryrun","tool_vault")},removeOnClose:!0}).then(function(a){return a.show(),a.getRoot().on(b.save,function(){return j(g,a)}),a.getRoot().on(b.cancel,function(){return a.hide()}),a})["catch"](d.exception)})},o=function(f){var g=document.querySelector(h.START_RESTORE+'[data-backupkey="'+f+'"]');g&&g.addEventListener("submit",function(f){f.preventDefault(),i({type:a.types.SAVE_CANCEL,title:e.get_string("startrestore","tool_vault"),body:c.render("tool_vault/start_restore_popup",{dryrun:0,encrypted:parseInt(g.getAttribute("data-encrypted"))}),buttons:{save:e.get_string("startrestore","tool_vault")},removeOnClose:!0}).then(function(a){return a.show(),a.getRoot().on(b.save,function(){return j(g,a)}),a.getRoot().on(b.cancel,function(){return a.hide()}),a})["catch"](d.exception)})},p=function(){var a=document.querySelector('[data-vault-purpose="logslong"]'),b=document.querySelector('[data-vault-purpose="logsshort"]');return a&&b&&(a.querySelector('[data-vault-purpose="togglelogs"]').addEventListener("click",function(c){c.preventDefault(),b.style.display="block",a.style.display="none"}),b.querySelector('[data-vault-purpose="togglelogs"]').addEventListener("click",function(c){c.preventDefault(),b.style.display="none",a.style.display="block"})),!1};return{initStartBackup:m,initStartDryRun:n,initStartRestore:o,initCollapseExpandBackupLogs:p}});