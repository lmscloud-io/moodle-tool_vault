define("tool_vault/install_addon",["exports","core_form/modalform","./selectors","core/str","core/notification"],(function(_exports,_modalform,_selectors,_str,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Links to install add-on plugins
   *
   * @module     tool_vault/install_addon
   * @copyright  Marina Glancy
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modalform=_interopRequireDefault(_modalform),_notification=_interopRequireDefault(_notification);let initialised=!1;const CLICOMMAND="/usr/bin/php admin/tool/vault/cli/addon_plugins.php";_exports.init=()=>{initialised||(initialised=!0,document.querySelectorAll(_selectors.SELECTORS.ADDON_PLUGIN_REGION).forEach((pluginRegionNode=>{pluginRegionNode.querySelectorAll(_selectors.SELECTORS.ADDON_VERSION_RADIO).forEach((el=>{el.addEventListener("change",(()=>{updateCliInstructions(pluginRegionNode,el),updateCliInstructionsBulk()}))}));const initialRadio=pluginRegionNode.querySelector(_selectors.SELECTORS.ADDON_VERSION_RADIO+":checked");updateCliInstructions(pluginRegionNode,initialRadio);const cliButton=pluginRegionNode.querySelector(_selectors.SELECTORS.ADDON_CLI_BUTTON),installButton=pluginRegionNode.dataset.writable?pluginRegionNode.querySelector(_selectors.SELECTORS.ADDON_INSTALL_BUTTON):null;null==installButton||installButton.addEventListener("click",(e=>{e.preventDefault(),pluginRegionNode.dataset.isbulk?openInstallAddonForm(pluginRegionNode.dataset.pluginnames.split(",")):openInstallAddonForm([pluginRegionNode.dataset.pluginname])})),null==cliButton||cliButton.addEventListener("click",(e=>{e.preventDefault(),pluginRegionNode.dataset.cliexpanded="1"==="".concat(pluginRegionNode.dataset.cliexpanded)?"0":"1"}))})),updateCliInstructionsBulk())};const updateCliInstructions=(pluginRegionNode,el)=>{const cli=pluginRegionNode.querySelector(_selectors.SELECTORS.ADDON_CLI_REGION);if(!cli)return;if(!el)return void(cli.innerHTML="");const source="".concat(el.value);let commandName=" --name="+(pluginRegionNode.dataset.pluginname+el.dataset.exactversion);pluginRegionNode.dataset.versionlocal&&(commandName+=" --overwrite"),""===source?cli.innerHTML="":source.match(/^backupkey\//)?cli.innerHTML="<pre>"+CLICOMMAND+" --backupkey="+source.substring(10)+commandName+"</pre>":cli.innerHTML="<pre>"+CLICOMMAND+commandName+"</pre>"},updateCliInstructionsBulk=()=>{document.querySelectorAll(_selectors.SELECTORS.ADDON_PLUGIN_REGION+'[data-isbulk="1"]').forEach((bulkRegion=>{const cli=bulkRegion.querySelector(_selectors.SELECTORS.ADDON_CLI_REGION);if(!cli)return;const commands={},pluginnames=bulkRegion.dataset.pluginnames.split(",");for(let pluginname of pluginnames){const el=getPluginRegion(pluginname).querySelector(_selectors.SELECTORS.ADDON_VERSION_RADIO+":checked");let k="moodleorg",prefix=CLICOMMAND;el&&""!=="".concat(null==el?void 0:el.value)&&(null!=el&&el.value.match(/^backupkey\//)&&(k=el.value.substring(10),prefix+=" --backupkey="+el.value.substring(10)),commands[k]=(k in commands?"".concat(commands[k],","):"".concat(prefix," --name="))+pluginname+el.dataset.exactversion)}Object.keys(commands).length?cli.innerHTML="<pre>"+Object.values(commands).join("\n")+"</pre>":cli.innerHTML=""}))},getPluginRegion=pluginname=>document.querySelector(_selectors.SELECTORS.ADDON_PLUGIN_REGION+'[data-pluginname="'.concat(pluginname,'"]')),openInstallAddonForm=pluginnames=>{const args=[],sources={};for(let pluginname of pluginnames){const pluginRegion=getPluginRegion(pluginname);if(null!=pluginRegion&&pluginRegion.dataset.writable){var _pluginRegion$querySe;const source=null===(_pluginRegion$querySe=pluginRegion.querySelector(_selectors.SELECTORS.ADDON_VERSION_RADIO+":checked"))||void 0===_pluginRegion$querySe?void 0:_pluginRegion$querySe.value;""!=="".concat(source)&&(args.push({pluginname:pluginname,source:source}),sources[pluginname]=source)}}if(!args.length)return;const modalForm=new _modalform.default({modalConfig:{title:(0,_str.get_string)("addonplugins_installdialoguetitle","tool_vault")},formClass:"\\tool_vault\\form\\install_plugin_form",args:{plugins:JSON.stringify(args)},saveButtonText:(0,_str.get_string)("continue","moodle")});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(event=>{for(let pluginname of event.detail.installed){var _pluginRegionNode$que,_pluginRegionNode$que2,_pluginRegionNode$que3;const pluginRegionNode=getPluginRegion(pluginname);null===(_pluginRegionNode$que=pluginRegionNode.querySelector(_selectors.SELECTORS.ADDON_CLI_BUTTON))||void 0===_pluginRegionNode$que||_pluginRegionNode$que.remove(),null===(_pluginRegionNode$que2=pluginRegionNode.querySelector(_selectors.SELECTORS.ADDON_INSTALL_BUTTON))||void 0===_pluginRegionNode$que2||_pluginRegionNode$que2.remove(),null===(_pluginRegionNode$que3=pluginRegionNode.querySelector(_selectors.SELECTORS.ADDON_CLI_REGION))||void 0===_pluginRegionNode$que3||_pluginRegionNode$que3.remove(),pluginRegionNode.querySelectorAll(_selectors.SELECTORS.ADDON_VERSION_RADIO).forEach((el=>{var _el$closest;el.value!==sources[pluginname]&&(null===(_el$closest=el.closest("label"))||void 0===_el$closest||_el$closest.classList.add("dimmed_text"));el.remove()}))}return updateCliInstructionsBulk(),_notification.default.alert((0,_str.get_string)("addonplugins_installdialoguetitle","tool_vault"),event.detail.output)})),modalForm.show()}}));

//# sourceMappingURL=install_addon.min.js.map