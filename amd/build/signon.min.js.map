{"version":3,"file":"signon.min.js","sources":["../src/signon.js"],"sourcesContent":["// This file is part of plugin tool_vault - https://lmsvault.io\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Manages login/register with lmsvault.io\n *\n * @module     tool_vault/signon\n * @copyright  2024 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {SELECTORS} from './selectors';\n\n/**\n * Open iframe with the remote login/signup form\n *\n * @param {Event} e\n */\nconst openLoginSignupModal = (e) => {\n    document.querySelector(SELECTORS.APIKEY_FORM_CONTAINER).innerHTML = '';\n    document.querySelector(SELECTORS.LEGACY_FORM_CONTAINER)?.classList.add('hidden');\n\n    const signInButton = e.target;\n    const loginSignupIframe = document.querySelector(SELECTORS.APIKEY_IFRAME);\n    const url = (signInButton && loginSignupIframe) ? signInButton.dataset.target : null;\n\n    loginSignupIframe.src = url;\n    loginSignupIframe.style.display = 'block';\n};\n\n/**\n * Close iframe with the remote login/signup form\n */\nexport const closeLoginSignupModal = () => {\n    const loginSignupIframe = document.querySelector(SELECTORS.APIKEY_IFRAME);\n    loginSignupIframe.style.display = 'none';\n    loginSignupIframe.src = 'about:blank';\n};\n\nexport const init = (onMessage) => {\n    const signInButton = document.querySelector(SELECTORS.SIGNIN_BUTTON);\n    const signUpButton = document.querySelector(SELECTORS.SIGNUP_BUTTON);\n    const loginSignupIframe = document.querySelector(SELECTORS.APIKEY_IFRAME);\n    const url = (signInButton && loginSignupIframe) ? signInButton.dataset.target : null;\n\n    if (!url) {\n        return;\n    }\n    const urlHost = url.match(/^(https?:\\/\\/[^/]+)(.*)$/)[1];\n\n    signInButton.onclick = openLoginSignupModal;\n    if (signUpButton) {\n        signUpButton.onclick = openLoginSignupModal;\n    }\n\n    const enterApikeyButton = document.querySelector(SELECTORS.ENTER_KEY_BUTTON);\n    enterApikeyButton.addEventListener('click', () => {\n        closeLoginSignupModal();\n    });\n\n    window.addEventListener(\n        \"message\",\n        (event) => {\n            if (event.origin !== urlHost || !event.data || !(typeof event.data === 'object')) {\n                return;\n            }\n            if (event.data.action === 'close') {\n                closeLoginSignupModal();\n            } else {\n                onMessage(event);\n            }\n        },\n        false);\n};\n"],"names":["openLoginSignupModal","e","document","querySelector","SELECTORS","APIKEY_FORM_CONTAINER","innerHTML","LEGACY_FORM_CONTAINER","classList","add","signInButton","target","loginSignupIframe","APIKEY_IFRAME","url","dataset","src","style","display","closeLoginSignupModal","onMessage","SIGNIN_BUTTON","signUpButton","SIGNUP_BUTTON","urlHost","match","onclick","ENTER_KEY_BUTTON","addEventListener","window","event","origin","data","action"],"mappings":";;;;;;;;MA8BMA,qBAAwBC,8BAC1BC,SAASC,cAAcC,qBAAUC,uBAAuBC,UAAY,iCACpEJ,SAASC,cAAcC,qBAAUG,+EAAwBC,UAAUC,IAAI,gBAEjEC,aAAeT,EAAEU,OACjBC,kBAAoBV,SAASC,cAAcC,qBAAUS,eACrDC,IAAOJ,cAAgBE,kBAAqBF,aAAaK,QAAQJ,OAAS,KAEhFC,kBAAkBI,IAAMF,IACxBF,kBAAkBK,MAAMC,QAAU,SAMzBC,sBAAwB,WAC3BP,kBAAoBV,SAASC,cAAcC,qBAAUS,eAC3DD,kBAAkBK,MAAMC,QAAU,OAClCN,kBAAkBI,IAAM,kFAGPI,kBACXV,aAAeR,SAASC,cAAcC,qBAAUiB,eAChDC,aAAepB,SAASC,cAAcC,qBAAUmB,eAChDX,kBAAoBV,SAASC,cAAcC,qBAAUS,eACrDC,IAAOJ,cAAgBE,kBAAqBF,aAAaK,QAAQJ,OAAS,SAE3EG,iBAGCU,QAAUV,IAAIW,MAAM,4BAA4B,GAEtDf,aAAagB,QAAU1B,qBACnBsB,eACAA,aAAaI,QAAU1B,sBAGDE,SAASC,cAAcC,qBAAUuB,kBACzCC,iBAAiB,SAAS,KACxCT,2BAGJU,OAAOD,iBACH,WACCE,QACOA,MAAMC,SAAWP,SAAYM,MAAME,MAAgC,iBAAfF,MAAME,OAGpC,UAAtBF,MAAME,KAAKC,OACXd,wBAEAC,UAAUU,WAGlB"}