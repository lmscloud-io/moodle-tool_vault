{"version":3,"file":"vault.min.js","sources":["../src/vault.js"],"sourcesContent":["// This file is part of plugin tool_vault - https://lmsvault.io\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript events for the `tool_vault` subsystem.\n *\n * @module tool_vault/vault\n * @copyright 2022 Marina Glancy\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport Pending from 'core/pending';\nimport Fragment from 'core/fragment';\n\nconst SELECTORS = {\n    START_BACKUP: 'form[data-action=\"startbackup\"]',\n    START_DRYRUN: 'form[data-action=\"startdryrun\"]',\n    START_RESTORE: 'form[data-action=\"startrestore\"]',\n};\n\nconst submitForm = (backupForm, modal) => {\n    const popupBody = modal.getBody()[0];\n    for (let i of ['passphrase', 'description']) {\n        const el1 = popupBody.querySelector(`input[name=\"${i}\"]`),\n            el2 = backupForm.querySelector(`input[name=\"${i}\"]`);\n        if (el1 && el2) {\n            el2.value = el1.value;\n        }\n    }\n    backupForm.setAttribute('action', backupForm.getAttribute('data-url'));\n    backupForm.submit();\n};\n\n/**\n * Loads a fragment with a popup showing a spinner while the fragment is loading.\n * In case of an error, the error message is shown in the same popup.\n *\n * @param {String} title\n * @param {String} tempBody\n * @param {String} fragmentName\n * @param {Number} contextid\n * @param {Object} args\n * @returns {Promise}\n */\nconst loadFragmentWithPopup = async(title, tempBody, fragmentName, contextid, args = {}) => {\n    let activeModal = null;\n    let fragment = null;\n    try {\n        activeModal = await ModalFactory.create({\n            type: ModalFactory.types.CANCEL,\n            title,\n            body: tempBody\n        });\n        activeModal.show();\n        fragment = await Fragment.loadFragment('tool_vault', fragmentName, contextid, args);\n        activeModal.destroy();\n    } catch (e) {\n        if (activeModal) {\n            activeModal.setBody(e.message);\n        } else {\n            Notification.exception(e);\n        }\n    }\n    return fragment;\n};\n\n/**\n * Register listener for \"start backup\" button\n */\nexport const initStartBackup = () => {\n    const backupForm = document.querySelector(SELECTORS.START_BACKUP);\n    if (!backupForm) {\n        return;\n    }\n    const contextid = backupForm.getAttribute('data-contextid');\n    backupForm.addEventListener('submit', async(event) => {\n        event.preventDefault();\n        const pendingPromise = new Pending('tool/vault:startBackupPopup');\n\n        const [title, tempBody, saveButtonText] = await getStrings([\n            {key: 'startbackup', component: 'tool_vault'},\n            {key: 'pleasewait', component: 'tool_vault'},\n            {key: 'startbackup', component: 'tool_vault'}\n        ]);\n        const fragment = await loadFragmentWithPopup(title, tempBody, 'start_backup', contextid);\n\n        if (!fragment) {\n            pendingPromise.resolve();\n            return;\n        }\n\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title,\n            body: fragment,\n            buttons: {save: saveButtonText},\n            removeOnClose: true\n        });\n        modal.show();\n\n        modal.getRoot().on(ModalEvents.save, () => submitForm(backupForm, modal));\n        modal.getRoot().on(ModalEvents.cancel, () => modal.hide());\n        pendingPromise.resolve();\n    });\n};\n\nexport const initStartDryRun = (backupkey) => {\n    const dryrunForm = document.querySelector(SELECTORS.START_DRYRUN + `[data-backupkey=\"${backupkey}\"]`);\n    if (!dryrunForm) {\n        return;\n    }\n    dryrunForm.addEventListener('submit', event => {\n        event.preventDefault();\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: getString('startdryrun', 'tool_vault'),\n            body: Templates.render('tool_vault/start_restore_popup',\n                {dryrun: 1, encrypted: parseInt(dryrunForm.getAttribute('data-encrypted'))}),\n            buttons: {save: getString('startdryrun', 'tool_vault')},\n            removeOnClose: true\n        })\n            .then(function(modal) {\n                modal.show();\n\n                modal.getRoot().on(ModalEvents.save, () => submitForm(dryrunForm, modal));\n                modal.getRoot().on(ModalEvents.cancel, () => modal.hide());\n\n                return modal;\n            })\n            .catch(Notification.exception);\n    });\n};\n\nexport const initStartRestore = (backupkey) => {\n    const restoreForm = document.querySelector(SELECTORS.START_RESTORE + `[data-backupkey=\"${backupkey}\"]`);\n    if (!restoreForm) {\n        return;\n    }\n    restoreForm.addEventListener('submit', event => {\n        event.preventDefault();\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: getString('startrestore', 'tool_vault'),\n            body: Templates.render('tool_vault/start_restore_popup',\n                {dryrun: 0, encrypted: parseInt(restoreForm.getAttribute('data-encrypted'))}),\n            buttons: {save: getString('startrestore', 'tool_vault')},\n            removeOnClose: true\n        })\n            .then(function(modal) {\n                modal.show();\n\n                modal.getRoot().on(ModalEvents.save, () => submitForm(restoreForm, modal));\n                modal.getRoot().on(ModalEvents.cancel, () => modal.hide());\n\n                return modal;\n            })\n            .catch(Notification.exception);\n    });\n};\n\nexport const initCollapseExpandBackupLogs = () => {\n    const logslong = document.querySelector(`[data-vault-purpose=\"logslong\"]`);\n    const logsshort = document.querySelector(`[data-vault-purpose=\"logsshort\"]`);\n    if (logslong && logsshort) {\n        logslong.querySelector(`[data-vault-purpose=\"togglelogs\"]`).addEventListener('click', event => {\n            event.preventDefault();\n            logsshort.style.display = 'block';\n            logslong.style.display = 'none';\n        });\n        logsshort.querySelector(`[data-vault-purpose=\"togglelogs\"]`).addEventListener('click', event => {\n            event.preventDefault();\n            logsshort.style.display = 'none';\n            logslong.style.display = 'block';\n        });\n    }\n    return false;\n};\n"],"names":["SELECTORS","submitForm","backupForm","modal","popupBody","getBody","i","el1","querySelector","el2","value","setAttribute","getAttribute","submit","loadFragmentWithPopup","title","tempBody","fragmentName","contextid","args","activeModal","fragment","ModalFactory","create","type","types","CANCEL","body","show","Fragment","loadFragment","destroy","setBody","_context","message","exception","document","addEventListener","event","preventDefault","pendingPromise","Pending","key","component","saveButtonText","resolve","SAVE_CANCEL","buttons","save","removeOnClose","getRoot","on","ModalEvents","cancel","hide","backupkey","dryrunForm","Templates","render","dryrun","encrypted","parseInt","then","catch","Notification","restoreForm","logslong","logsshort","style","display"],"mappings":"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"}